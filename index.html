<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Derivadas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11.8.0/lib/browser/math.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
  <style>
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h1>Calculadora de Derivadas</h1>
  <p>Ingresa tu función y obtén la derivada simbólica, el cálculo por límites (forma corta) y la gráfica.</p>
  <label>Función: <input id="fn" value="x^3 + 2*x^2 - 5*x + sin(x)" style="width:60%"></label>
  <label>Variable: <input id="var" value="x" style="width:80px"></label>
  <label>Punto: <input id="point" value="1" style="width:80px"></label>
  <br>
  <button id="calc">Calcular</button>
  <button id="reset">Limpiar</button>
  <hr>
  <div class="grid">
    <div>
      <h3>Derivada simbólica</h3>
      <div id="deriv-latex">—</div>
      <h4>Simplificada</h4>
      <div id="simpl-latex">—</div>
      <h4>Evaluada en el punto</h4>
      <div id="eval-num">—</div>
      <h4>Límite (forma corta)</h4>
      <div id="limit-table"></div>
    </div>
    <div>
      <h3>Gráfica</h3>
      <div id="plot" style="height:420px;"></div>
    </div>
  </div>
  <script>
    function toTex(expr){
      try{ return math.parse(expr).toTex({parenthesis:'keep', implicit:'show'}); }catch{return null;}
    }
    function renderLatex(id, tex){
      const el = document.getElementById(id);
      el.innerHTML = tex ? `\\(${tex}\\)` : 'Error';
      MathJax.typesetPromise([el]);
    }
    function showTable(rows){
      let html = '<table><tr><th>h</th><th>(f(x+h)-f(x))/h</th></tr>';
      rows.forEach(r=> html += `<tr><td>${r.h}</td><td>${r.val}</td></tr>`);
      html += '</table>'; document.getElementById('limit-table').innerHTML = html;
    }
    function numericLimit(fnNode, variable, x0){
      const f = math.compile(fnNode.toString());
      return [1e-1,1e-2,1e-3,1e-4,1e-5,1e-6].map(h=>({
        h, val: Number(((f.evaluate({[variable]:x0+h})-f.evaluate({[variable]:x0}))/h).toPrecision(12))
      }));
    }
    function plotFn(fnExpr, derivExpr, variable){
      const traceFn = {x:[], y:[], name:'f(x)', mode:'lines'};
      const traceDer = {x:[], y:[], name:"f'(x)", mode:'lines'};
      const x0 = Number(document.getElementById('point').value) || 0;
      const xmin = x0-5, xmax = x0+5, N=400, step=(xmax-xmin)/N;
      const f = math.compile(fnExpr), d = math.compile(derivExpr);
      for(let i=0;i<=N;i++){
        const xv = xmin+i*step;
        traceFn.x.push(xv); traceFn.y.push(f.evaluate({[variable]:xv}));
        traceDer.x.push(xv); traceDer.y.push(d.evaluate({[variable]:xv}));
      }
      Plotly.newPlot('plot',[traceFn, traceDer], {legend:{orientation:'h'}});
    }
    document.getElementById('calc').onclick=()=>{
      const expr=document.getElementById('fn').value.trim();
      const variable=document.getElementById('var').value.trim();
      const point=Number(document.getElementById('point').value);
      try{
        const node=math.parse(expr);
        const deriv=math.derivative(node, variable);
        const simp=math.simplify(deriv);
        renderLatex('deriv-latex', deriv.toTex({parenthesis:'keep',implicit:'show'}));
        renderLatex('simpl-latex', simp.toTex({parenthesis:'keep',implicit:'show'}));
        document.getElementById('eval-num').innerText = `f'(${point}) = ${Number(simp.evaluate({[variable]:point}).toPrecision(12))}`;
        showTable(numericLimit(node, variable, point));
        plotFn(expr, simp.toString(), variable);
      }catch{alert('Error en la función');}
    }
    document.getElementById('reset').onclick=()=>{
      document.getElementById('fn').value='';
      document.getElementById('deriv-latex').innerHTML='—';
      document.getElementById('simpl-latex').innerHTML='—';
      document.getElementById('eval-num').innerText='—';
      document.getElementById('limit-table').innerHTML='';
      document.getElementById('plot').innerHTML='';
    }
  </script>
</body>
</html>
